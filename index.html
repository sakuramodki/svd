<!doctype html>
<html>
 <head>
  <title>Self Camera</title>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js'></script>
 </head>
 <body>
   <div id='effected' style='float:left;'></div>
   <video id='video' width='490' height='360' autoplay='1' ></video>
   <br/>
   param1: <input type='range' id='param1' name='param1' min='0.0' max='1.0' step='any'/><div id='param1val'></div><br/>
   param2: <input type='range' id='param2' name='param2' min='0.0' max='1.0' step='any'/><div id='param2val'></div><br/>
   param3: <input type='range' id='param3' name='param3' min='0.0' max='1.0' step='any'/><div id='param3val'></div><br/>
   <input type="button" id='fullscreen' value='fullscreen'/>
 </body>
 <script type='text/javascript'>
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || window.navigator.mozGetUserMedia;
    window.URL = window.URL || window.webkitURL;
    var video = document.getElementById('video');
    var localStream = null;
    navigator.getUserMedia({video: true, audio: false}, function(stream) { // for success case
		 video.src = window.URL.createObjectURL(stream);
		},
		function(err) { // for error case
		   console.log(err);
		}
    );
</script>
<script src='http://evanw.github.io/glfx.js/glfx.js'></script>
<script type='text/javascript'>
var subwindow = window.open("about:blank", "_blank", "height=30, width=40");
subwindow.document.write('<HTML><BODY><center><canvas id="subcanvas" style="background-color:black"></canvs><center></BODY><HTML`>');
window.focus();
$(window).unload(function () {
	alert();
	subwindow.close();
});

$(document).ready(function() {
    try {
        var canvas = fx.canvas();
    } catch (e) {
        alert(e);
        return;
    }

	$('#effected').prepend(canvas);

	window.setInterval(function () {
		var video   = $('#video'),
		    fs      = $('#fsobj'),
		    texture = canvas.texture(video.get(0)),
		    param1  = $('#param1').val(),
		    param2  = $('#param2').val(),
		    param3  = $('#param3').val();
		canvas.draw(texture).brightnessContrast((param1-0.5)*2, (param2-0.5)*2, 0).update();

		var png = $('#effected canvas').get(0).toDataURL();
		var img = new Image();
		img.src = png;
		var subcanvs = subwindow.document.body.getElementsByTagName('canvas')[0];
		subcanvs.width = screen.width;
		subcanvs.height = screen.height;
		var amp = Math.min(screen.width/img.width , screen.height/img.height)
		var ctx = subcanvs.getContext('2d');
		ctx.drawImage(img, 0,0,amp*img.width, amp*img.height);
	},1000/60);
});

// parameter event
$(document).ready( function () {
	var ids = ['param1', 'param2', 'param3'];
	for (var i in ids) {
		var id = ids[i];
		$('#'+id).on('input', function ()	{
			var id = $(this).attr('id');
			$('#'+id+'val').html('val:' + $(this).val());
		});
	};
	$('#fullscreen').click(function () {
		var subcanvs = subwindow.document.body.getElementsByTagName('canvas')[0];
		var x = subcanvs;
		if (x.webkitRequestFullScreen) {
			x.webkitRequestFullScreen();
		} else {
			x.requestFullScreen();
		}
	});
});
   </script>
</html>
